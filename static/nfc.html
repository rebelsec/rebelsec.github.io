<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fullscreen → Delay → Web NFC Permission (PoC)</title>
  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --accent:#0ea5a4; --muted:#6b7280;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);display:flex;align-items:center;justify-content:center}
    .card{width:360px;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(2,6,23,0.08);text-align:center}
    h1{font-size:18px;margin:0 0 8px}
    p.lead{margin:0 0 14px;color:var(--muted);font-size:13px}
    button{background:var(--accent);color:#fff;border:0;padding:12px 16px;border-radius:10px;font-weight:600;cursor:pointer}
    .status{margin-top:12px;font-size:13px;color:var(--muted)}
    .small{font-size:12px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="card" role="main">
    <h1>Fullscreen → Delay → Web NFC</h1>
    <p class="lead">Click to enter fullscreen. After 5s the page will request NFC permission (Chrome on Android only).</p>
    <button id="startBtn">Click to start</button>
    <div id="status" class="status">Status: idle</div>
    <div class="small">Requires HTTPS and Chrome for Android with Web NFC support.</div>
  </div>

<script>
(function(){
  const btn = document.getElementById('startBtn');
  const statusEl = document.getElementById('status');

  function setStatus(txt){
    statusEl.textContent = 'Status: ' + txt;
  }

  async function enterFullscreen(){
    try{
      if (document.fullscreenElement) return true; // already fullscreen
      if (document.documentElement.requestFullscreen) {
        await document.documentElement.requestFullscreen();
        return true;
      } else {
        setStatus('Fullscreen API not supported.');
        return false;
      }
    } catch (e) {
      console.error('requestFullscreen error', e);
      setStatus('Failed to enter fullscreen: ' + (e.message || e.name));
      return false;
    }
  }

  async function requestNfcPermission(){
    if (!('NDEFReader' in window)) {
      setStatus('Web NFC API not supported on this browser.');
      return;
    }

    try {
      setStatus('Requesting NFC permission (prompt)...');
      const reader = new NDEFReader();
      // scan() will trigger the permission prompt
      await reader.scan();
      setStatus('NFC permission granted — scanning started.');
      reader.onreading = event => {
        // display a short summary of the first record for demo
        try {
          const r = event.message.records[0];
          const textDecoder = new TextDecoder(r.encoding || 'utf-8');
          const content = textDecoder.decode(r.data);
          setStatus('NFC tag read: ' + content);
        } catch (err) {
          setStatus('NFC tag read (non-text record)');
        }
      };
      reader.onreadingerror = () => setStatus('NFC reading error.');
    } catch (err) {
      console.error('NFC request error', err);
      if (err.name === 'NotAllowedError') {
        setStatus('Permission denied by user.');
      } else if (err.name === 'NotSupportedError') {
        setStatus('NFC unavailable or turned off at OS level.');
      } else if (err.name === 'SecurityError' || err.name === 'NetworkError') {
        setStatus('Page must be served over HTTPS and in a top-level context.');
      } else {
        setStatus('NFC request failed: ' + (err.message || err.name));
      }
    }
  }

  btn.addEventListener('click', async () => {
    btn.disabled = true;
    setStatus('Attempting to enter fullscreen...');
    const ok = await enterFullscreen();
    if (!ok) { btn.disabled = false; return; }

    setStatus('Entered fullscreen. Waiting 5 seconds before requesting NFC permission...');
    // Delay 5 seconds (5000ms)
    await new Promise(resolve => setTimeout(resolve, 5000));

    // Optionally verify still fullscreen:
    if (!document.fullscreenElement) {
      setStatus('Not in fullscreen anymore — aborting NFC request.');
      btn.disabled = false;
      return;
    }

    // Now request NFC permission
    await requestNfcPermission();
    // leave the button disabled to avoid repeated prompts — you may re-enable if desired
    btn.disabled = false;
  });

  // Clean up if user exits fullscreen via ESC or gesture
  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      setStatus('Exited fullscreen.');
    }
  });

})();
</script>
</body>
</html>
